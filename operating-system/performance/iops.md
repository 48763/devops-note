# IOPs

IOPS（Input/Output Operations Per Second）是儲存裝置的效能測試量測方式，其指的是每秒讀寫次數。

最近伺服器遇到讀寫延遲過高的問題，原因發生在某一台虛擬機讀寫需求過高及頻繁。

在伺服器上並沒有做硬碟的相關限制，所以只要該虛擬機需要，便能佔盡伺服器的資源，造成伺服器及其它虛擬機讀取延遲。最後變得要去設置（也應該要）設置硬碟的 IOPs，才阻止資源被單一虛擬機強占的狀況。

在伺服器上設置 IOPs 是非常簡單的事情，一般硬碟通常都設置 100。所以本篇主要是紀錄相關的資訊，也可作為實務上參考評估的依據。

## 儲存衡量指標

### 吞吐量（Throughput）

單位時間內傳輸的資料量。往往以 *KBPS* 或 *MBPS* 來衡量。

### 回應時間（Latency）

指完成一個IO請求所需要的時間。往往以毫秒（ms）來衡量。

### IOPS（Input-Output Per Second）

衡量在一秒內能完成多少讀操作和寫操作。

## IOPs 計算方式

公式：
```
IOPS = 1000／(尋址時間（Seek Latency）+ 回應時間（Rotational Latency）
```

```
IOPS * 區塊大小（Block Size） * 軸（spindles） = 吞吐量（throughput）
```

## 儲存裝置

### 一般硬碟
隨機存取處理裝置常見的 IOPs 平均值：

|   裝置   |	形式    |	IOPS    |	介面    |	註解    |
|    -    |    -    |    -    |    -    |    -    |
|7,200 RPM SATA硬碟機	|硬碟機	|   75-100 	|SATA 3 Gbit/s|
|10,000 RPM SATA硬碟機	|硬碟機	|   125-150	|SATA 3 Gbit/s|
|10,000 RPM SAS硬碟機	|硬碟機	|   140   	|SAS（串列SCSI）|
|15,000 RPM SAS硬碟機	|硬碟機	|   175-210 |SAS（串列SCSI）|
> 讀寫操作適用於 256KB 或更小的區塊。如果區塊大小為 1024KB，則只需要原先的 1/4 IOPs。

### 固態硬碟

影響固態硬碟的壽命因素：
- 顆粒（SLC, MLC, TLC）
- 控制器特性（Marvell - 追求速度，SandForce - 追求壽命）
- 容量(容量越大可寫入次數越多)

SSD 是靠電晶體的電壓狀態來判讀資料，在讀取資料時並不會改變電晶體狀態，固不會減少使用壽命；而寫入資料時會改變電晶體狀態，則會減少使用壽命。

SSD顆粒壽命：
- SLC 約寫入 100,000次
- MLC 約寫入 10,000次
- TLC 約寫入 500次

粗略計算：
```
(240GB（硬碟容量） * 500（TLC 寫入次數）)／100GB（平均一天寫入量） = 2400天（可用天數）
```

>這公式僅大略粗估用，完全不考慮磁碟中的資料搬移狀況。
>可閱讀 [iThome](https://www.ithome.com.tw/tech/92220) 有關 page 和 block 問題。

### 磁碟陣列（RAID）

| RAID 類型 | 讀寫開銷|
|   :-      |  :-:  | 
| RAID 0    |   0   | 
| RAID 1/10 |   2   |
| RAID 5    |   4   |
| RAID 6    |   6   |

計算方式：
```
(IOPS * 硬碟數量) / (0.5（讀） + (0.5（寫） * 2)) = IOPs 總量
```

[參考：網管人](https://netadmin.com.tw/article_content.aspx?sn=1402100001&jump=2)

## 結語

本篇單純將硬碟相關的資訊排版整理以及介紹，因為要討論實際應用範圍有點大（~~嫌麻煩~~）。但在這仍可以提供一些考慮的要素：
- 寫入資料平均大小
- 更動資料頻率
- 讀取資料頻率
- 應用容許回應延遲時間

